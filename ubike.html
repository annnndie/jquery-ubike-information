<!DOCTYPE html>
<html>
<title>YouBike 臺北市公共自行車即時資訊</title>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css"
  integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">

<style>
  body {
    padding: 1em;
  }

  .form-inline {
    margin: 2rem 0;
  }
</style>

<body>

  <h1>YouBike 臺北市公共自行車即時資訊</h1>

  <form class="form-inline">
    <input type="text" id="keyword" class="form-control mx-sm-3" placeholder="請輸入關鍵字">
    <button type="button" id="search" class="btn btn-primary">Submit</button>
  </form>

  <table id="you-bike-tbl" class="table table-striped">
    <thead>
      <tr>
        <th>#</th>
        <th>場站名稱</th>
        <th>場站區域</th>
        <th>目前可用車輛</th>
        <th>總停車格</th>
        <th>資料更新時間</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>0001</td>
        <td>捷運市政府站(3號出口)</td>
        <td>信義區</td>
        <td>21</td>
        <td>180</td>
        <td>2020/11/20 12:00:00</td>
      </tr>
      <tr>
        <td>0002</td>
        <td>捷運國父紀念館站(2號出口)</td>
        <td>大安區</td>
        <td>32</td>
        <td>48</td>
        <td>2020/11/20 12:00:00</td>
      </tr>
      <tr>
        <td>0003</td>
        <td>台北市政府</td>
        <td>信義區</td>
        <td>18</td>
        <td>40</td>
        <td>2020/11/20 12:00:00</td>
      </tr>
      <tr>
        <td>0004</td>
        <td>市民廣場</td>
        <td>信義區</td>
        <td>33</td>
        <td>60</td>
        <td>2020/11/20 12:00:00</td>
      </tr>
      <tr>
        <td>0005</td>
        <td>興雅國中</td>
        <td>信義區</td>
        <td>31</td>
        <td>60</td>
        <td>2020/11/20 12:00:00</td>
      </tr>
    </tbody>

  </table>


  <script
    src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
    crossorigin="anonymous"></script>

  <script type="text/javascript">
    /*
      欄位說明
      sno：站點代號
      sna：場站名稱(中文)
      tot：場站總停車格、
      sbi：場站目前車輛數量
      sarea：場站區域(中文)
      mday：資料更新時間、
      lat：緯度
      lng：經度
      ar：地(中文)
      sareaen：場站區域(英文)
      snaen：場站名稱(英文)
      aren：地址(英文)
      bemp：空位數量
      act：全站禁用狀態
    */

    // 時間格式處理
    const timeFormat = function (t) {
      const date = [], time = [];

      date.push(t.substr(0, 4));
      date.push(t.substr(4, 2));
      date.push(t.substr(6, 2));
      time.push(t.substr(8, 2));
      time.push(t.substr(10, 2));
      time.push(t.substr(12, 2));
      return date.join("/") + ' ' + time.join(":");
    }

    $.get('https://tcgbusfs.blob.core.windows.net/blobyoubike/YouBikeTP.gz',
      function (data) {        
        // 將資料轉為 JSON
        const { retVal } = JSON.parse(data);
        // 將回傳值轉為陣列
        const stops = Object.keys(retVal).map(key => retVal[key]);

        // 畫表格
        const render = function (stops) {
          let htmlStr = '';

          for (idx in stops) {
            const { sno, sna, sarea, sbi, tot, mday } = stops[idx];
            htmlStr += `<tr>
              <td>${sno}</td>
              <td>${sna}</td>
              <td>${sarea}</td>
              <td>${sbi}</td>
              <td>${tot}</td>
              <td>${timeFormat(mday)}</td>
            </tr>`;
          }

          $('#you-bike-tbl tbody').empty();
          $('#you-bike-tbl tbody').html(htmlStr);
        };

        render(stops);

        // todo 2: 加入關鍵字搜尋功能
        $('#search').on('click', function(e) {
          // code here...
          

        });

      });

  </script>

</body>

</html>
